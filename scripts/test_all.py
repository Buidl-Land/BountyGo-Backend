#!/usr/bin/env python3
"""
BountyGo Backend - ÂÖ®Èù¢ÊµãËØïËÑöÊú¨
ÂåÖÂê´Êï∞ÊçÆÂ∫ìÂàùÂßãÂåñ„ÄÅÊ®°ÂûãÈ™åËØÅ„ÄÅAPIÊµãËØïÁ≠âÊâÄÊúâÂäüËÉΩ
"""
import sys
import os
import asyncio
import subprocess
import time
import requests
from pathlib import Path
from urllib.parse import urlparse

# Add the app directory to the path
sys.path.append(str(Path(__file__).parent.parent))

import psycopg2
import logging
from app.core.config import settings

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)


class BountyGoTester:
    """BountyGoÂÖ®Èù¢ÊµãËØïÂô®"""
    
    def __init__(self):
        self.success_count = 0
        self.total_tests = 6
        
    def get_connection_params(self):
        """Ëé∑ÂèñÊï∞ÊçÆÂ∫ìËøûÊé•ÂèÇÊï∞"""
        db_url = settings.DATABASE_URL
        if db_url.startswith("postgresql+asyncpg://"):
            db_url = db_url.replace("postgresql+asyncpg://", "postgresql://")
        
        parsed = urlparse(db_url)
        
        return {
            'host': parsed.hostname,
            'port': parsed.port or 5432,
            'database': parsed.path[1:] if parsed.path else 'postgres',
            'user': parsed.username,
            'password': parsed.password
        }

    def test_database_connection(self):
        """ÊµãËØïÊï∞ÊçÆÂ∫ìËøûÊé•"""
        try:
            logger.info("üîç ÊµãËØïÊï∞ÊçÆÂ∫ìËøûÊé•...")
            
            conn_params = self.get_connection_params()
            logger.info(f"ËøûÊé•Âà∞: {conn_params['host']}:{conn_params['port']}")
            
            conn = psycopg2.connect(**conn_params)
            cur = conn.cursor()
            
            cur.execute("SELECT version()")
            version = cur.fetchone()[0]
            logger.info(f"‚úÖ Êï∞ÊçÆÂ∫ìËøûÊé•ÊàêÂäü!")
            logger.info(f"PostgreSQLÁâàÊú¨: {version[:50]}...")
            
            cur.close()
            conn.close()
            return True
            
        except Exception as e:
            logger.error(f"‚ùå Êï∞ÊçÆÂ∫ìËøûÊé•Â§±Ë¥•: {e}")
            return False

    def initialize_database(self):
        """ÂàùÂßãÂåñÊï∞ÊçÆÂ∫ì"""
        try:
            logger.info("üî® ÂºÄÂßãÂàùÂßãÂåñÊï∞ÊçÆÂ∫ì...")
            
            conn_params = self.get_connection_params()
            conn = psycopg2.connect(**conn_params)
            cur = conn.cursor()
            
            # ÂàõÂª∫Êâ©Â±ï
            cur.execute('CREATE EXTENSION IF NOT EXISTS "uuid-ossp"')
            cur.execute('CREATE EXTENSION IF NOT EXISTS "pg_trgm"')
            
            # ÂàõÂª∫ÊâÄÊúâË°®
            tables = [
                # Áî®Êà∑Ë°®
                """
                CREATE TABLE IF NOT EXISTS users (
                    id BIGSERIAL PRIMARY KEY,
                    google_id VARCHAR(255) UNIQUE,
                    email VARCHAR(255) UNIQUE NOT NULL,
                    nickname VARCHAR(100) NOT NULL,
                    avatar_url TEXT,
                    is_active BOOLEAN NOT NULL DEFAULT true,
                    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
                )
                """,
                # Ê†áÁ≠æË°®
                """
                CREATE TABLE IF NOT EXISTS tags (
                    id BIGSERIAL PRIMARY KEY,
                    name VARCHAR(100) UNIQUE NOT NULL,
                    category VARCHAR(50) NOT NULL,
                    description TEXT,
                    usage_count INTEGER NOT NULL DEFAULT 0,
                    is_active BOOLEAN NOT NULL DEFAULT true,
                    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
                )
                """,
                # ‰ªªÂä°Ë°®
                """
                CREATE TABLE IF NOT EXISTS tasks (
                    id BIGSERIAL PRIMARY KEY,
                    title VARCHAR(255) NOT NULL,
                    description TEXT,
                    reward DECIMAL(18, 6),
                    reward_currency VARCHAR(10) NOT NULL DEFAULT 'USD',
                    deadline TIMESTAMPTZ,
                    sponsor_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
                    external_link TEXT,
                    status VARCHAR(20) NOT NULL DEFAULT 'active',
                    view_count INTEGER NOT NULL DEFAULT 0,
                    join_count INTEGER NOT NULL DEFAULT 0,
                    has_escrow BOOLEAN NOT NULL DEFAULT false,
                    escrow_amount DECIMAL(18, 6),
                    escrow_token VARCHAR(42),
                    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
                )
                """,
                # ÂÖ∂‰ªñË°®...
                """
                CREATE TABLE IF NOT EXISTS user_wallets (
                    id BIGSERIAL PRIMARY KEY,
                    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
                    wallet_address VARCHAR(42) UNIQUE NOT NULL,
                    wallet_type VARCHAR(20) NOT NULL DEFAULT 'ethereum',
                    is_primary BOOLEAN NOT NULL DEFAULT false,
                    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
                )
                """,
                """
                CREATE TABLE IF NOT EXISTS refresh_tokens (
                    id BIGSERIAL PRIMARY KEY,
                    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
                    token_hash VARCHAR(255) UNIQUE NOT NULL,
                    expires_at TIMESTAMPTZ NOT NULL,
                    is_revoked BOOLEAN NOT NULL DEFAULT false,
                    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
                )
                """,
                """
                CREATE TABLE IF NOT EXISTS user_tag_profiles (
                    id BIGSERIAL PRIMARY KEY,
                    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
                    tag_id BIGINT NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
                    weight DECIMAL(5, 4) NOT NULL DEFAULT 1.0,
                    last_updated TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    UNIQUE(user_id, tag_id)
                )
                """,
                """
                CREATE TABLE IF NOT EXISTS task_tags (
                    id BIGSERIAL PRIMARY KEY,
                    task_id BIGINT NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
                    tag_id BIGINT NOT NULL REFERENCES tags(id) ON DELETE CASCADE,
                    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    UNIQUE(task_id, tag_id)
                )
                """,
                """
                CREATE TABLE IF NOT EXISTS todos (
                    id BIGSERIAL PRIMARY KEY,
                    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
                    task_id BIGINT NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
                    added_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    remind_flags TEXT DEFAULT '{"t_3d": true, "t_1d": true, "ddl_2h": true}',
                    is_active BOOLEAN NOT NULL DEFAULT true,
                    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    UNIQUE(user_id, task_id)
                )
                """,
                """
                CREATE TABLE IF NOT EXISTS messages (
                    id BIGSERIAL PRIMARY KEY,
                    task_id BIGINT NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
                    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
                    content TEXT NOT NULL,
                    is_deleted BOOLEAN NOT NULL DEFAULT false,
                    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
                )
                """,
                """
                CREATE TABLE IF NOT EXISTS task_views (
                    id BIGSERIAL PRIMARY KEY,
                    task_id BIGINT NOT NULL REFERENCES tasks(id) ON DELETE CASCADE,
                    user_id BIGINT REFERENCES users(id) ON DELETE SET NULL,
                    viewed_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    ip_address VARCHAR(45),
                    user_agent TEXT,
                    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
                    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
                )
                """
            ]
            
            for table_sql in tables:
                cur.execute(table_sql)
            
            # ÂàõÂª∫Á¥¢Âºï
            indexes = [
                "CREATE INDEX IF NOT EXISTS idx_tasks_sponsor_status ON tasks(sponsor_id, status)",
                "CREATE INDEX IF NOT EXISTS idx_todos_user_active ON todos(user_id, is_active)",
                "CREATE INDEX IF NOT EXISTS idx_messages_task_created ON messages(task_id, created_at)",
                "CREATE INDEX IF NOT EXISTS idx_tags_category ON tags(category, is_active)",
                "CREATE INDEX IF NOT EXISTS idx_tags_name ON tags(name)",
                "CREATE INDEX IF NOT EXISTS idx_task_tags_task ON task_tags(task_id)",
                "CREATE INDEX IF NOT EXISTS idx_task_tags_tag ON task_tags(tag_id)",
                "CREATE INDEX IF NOT EXISTS idx_user_tag_profiles_user ON user_tag_profiles(user_id)",
                "CREATE INDEX IF NOT EXISTS idx_user_tag_profiles_tag ON user_tag_profiles(tag_id)",
                "CREATE INDEX IF NOT EXISTS idx_task_views_task ON task_views(task_id)",
                "CREATE INDEX IF NOT EXISTS idx_task_views_user ON task_views(user_id)"
            ]
            
            for index_sql in indexes:
                cur.execute(index_sql)
            
            # ÂàõÂª∫AlembicÁâàÊú¨Ë°®
            cur.execute("""
                CREATE TABLE IF NOT EXISTS alembic_version (
                    version_num VARCHAR(32) NOT NULL,
                    CONSTRAINT alembic_version_pkc PRIMARY KEY (version_num)
                )
            """)
            
            cur.execute("""
                INSERT INTO alembic_version (version_num) 
                VALUES ('001') 
                ON CONFLICT (version_num) DO NOTHING
            """)
            
            conn.commit()
            cur.close()
            conn.close()
            
            logger.info("‚úÖ Êï∞ÊçÆÂ∫ìÂàùÂßãÂåñÂÆåÊàê!")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå Êï∞ÊçÆÂ∫ìÂàùÂßãÂåñÂ§±Ë¥•: {e}")
            return False

    def insert_sample_data(self):
        """ÊèíÂÖ•Á§∫‰æãÊï∞ÊçÆ"""
        try:
            logger.info("üìù ÊèíÂÖ•Á§∫‰æãÊï∞ÊçÆ...")
            
            conn_params = self.get_connection_params()
            conn = psycopg2.connect(**conn_params)
            cur = conn.cursor()
            
            # ÊèíÂÖ•Ê†áÁ≠æ
            sample_tags = [
                ("Python", "skill", "PythonÁºñÁ®ãËØ≠Ë®Ä"),
                ("JavaScript", "skill", "JavaScriptÁºñÁ®ãËØ≠Ë®Ä"),
                ("WebÂºÄÂèë", "industry", "WebÂºÄÂèëË°å‰∏ö"),
                ("ÁßªÂä®ÂºÄÂèë", "industry", "ÁßªÂä®Â∫îÁî®ÂºÄÂèë"),
                ("ËßÜÈ¢ë", "media", "ËßÜÈ¢ëÂÜÖÂÆπ"),
                ("ÊñáÁ´†", "media", "ÊñáÂ≠óÊñáÁ´†"),
                ("Âå∫ÂùóÈìæ", "industry", "Âå∫ÂùóÈìæÊäÄÊúØ"),
                ("AI/ML", "skill", "‰∫∫Â∑•Êô∫ËÉΩÂíåÊú∫Âô®Â≠¶‰π†"),
            ]
            
            for name, category, description in sample_tags:
                cur.execute("""
                    INSERT INTO tags (name, category, description) 
                    VALUES (%s, %s, %s) 
                    ON CONFLICT (name) DO NOTHING
                """, (name, category, description))
            
            # ÊèíÂÖ•Áî®Êà∑
            cur.execute("""
                INSERT INTO users (email, nickname, google_id) 
                VALUES (%s, %s, %s) 
                ON CONFLICT (email) DO UPDATE SET nickname = EXCLUDED.nickname
                RETURNING id
            """, ("test@bountygo.com", "ÊµãËØïÁî®Êà∑", "test_google_123"))
            
            user_result = cur.fetchone()
            user_id = user_result[0] if user_result else None
            
            if not user_id:
                cur.execute("SELECT id FROM users WHERE email = %s", ("test@bountygo.com",))
                result = cur.fetchone()
                user_id = result[0] if result else None
            
            if user_id:
                # ÊèíÂÖ•‰ªªÂä°
                cur.execute("""
                    INSERT INTO tasks (title, description, reward, reward_currency, sponsor_id, external_link) 
                    VALUES (%s, %s, %s, %s, %s, %s) 
                    RETURNING id
                """, (
                    "BountyGoÂπ≥Âè∞ÊµãËØï‰ªªÂä°", 
                    "ËøôÊòØ‰∏Ä‰∏™Áî®‰∫éÊµãËØïBountyGoÂπ≥Âè∞ÂäüËÉΩÁöÑÁ§∫‰æã‰ªªÂä°„ÄÇ", 
                    100.0, 
                    "USD", 
                    user_id, 
                    "https://github.com/bountygo/test-task"
                ))
                
                task_result = cur.fetchone()
                task_id = task_result[0] if task_result else None
                
                if task_id:
                    # Ê∑ªÂä†‰ªªÂä°Ê†áÁ≠æ
                    cur.execute("SELECT id FROM tags WHERE name = %s", ("Python",))
                    python_tag_result = cur.fetchone()
                    python_tag_id = python_tag_result[0] if python_tag_result else None
                    
                    cur.execute("SELECT id FROM tags WHERE name = %s", ("WebÂºÄÂèë",))
                    web_tag_result = cur.fetchone()
                    web_tag_id = web_tag_result[0] if web_tag_result else None
                    
                    if python_tag_id and web_tag_id:
                        cur.execute("""
                            INSERT INTO task_tags (task_id, tag_id) 
                            VALUES (%s, %s), (%s, %s)
                            ON CONFLICT (task_id, tag_id) DO NOTHING
                        """, (task_id, python_tag_id, task_id, web_tag_id))
                        
                        # Ê∑ªÂä†Áî®Êà∑Ê†áÁ≠æÈÖçÁΩÆ
                        cur.execute("""
                            INSERT INTO user_tag_profiles (user_id, tag_id, weight) 
                            VALUES (%s, %s, %s), (%s, %s, %s)
                            ON CONFLICT (user_id, tag_id) DO UPDATE SET weight = EXCLUDED.weight
                        """, (user_id, python_tag_id, 0.9, user_id, web_tag_id, 0.8))
            
            conn.commit()
            cur.close()
            conn.close()
            
            logger.info("‚úÖ Á§∫‰æãÊï∞ÊçÆÊèíÂÖ•ÂÆåÊàê!")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå Á§∫‰æãÊï∞ÊçÆÊèíÂÖ•Â§±Ë¥•: {e}")
            return False

    def test_models_import(self):
        """ÊµãËØïÊ®°ÂûãÂØºÂÖ•"""
        try:
            logger.info("üì¶ ÊµãËØïÊ®°ÂûãÂØºÂÖ•...")
            
            from app.models import User, Tag, Task, UserWallet, RefreshToken
            from app.schemas import UserCreate, TagCreate, TaskCreate
            from app.main import app
            
            logger.info("‚úÖ ÊâÄÊúâÊ®°ÂûãÂíåschemasÂØºÂÖ•ÊàêÂäü!")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå Ê®°ÂûãÂØºÂÖ•Â§±Ë¥•: {e}")
            return False

    def test_database_queries(self):
        """ÊµãËØïÊï∞ÊçÆÂ∫ìÊü•ËØ¢"""
        try:
            logger.info("üîç ÊµãËØïÊï∞ÊçÆÂ∫ìÊü•ËØ¢...")
            
            conn_params = self.get_connection_params()
            conn = psycopg2.connect(**conn_params)
            cur = conn.cursor()
            
            # ÁªüËÆ°Êü•ËØ¢
            cur.execute("SELECT COUNT(*) FROM users")
            user_count = cur.fetchone()[0]
            
            cur.execute("SELECT COUNT(*) FROM tags")
            tag_count = cur.fetchone()[0]
            
            cur.execute("SELECT COUNT(*) FROM tasks")
            task_count = cur.fetchone()[0]
            
            logger.info(f"üìä Êï∞ÊçÆÁªüËÆ°: {user_count} Áî®Êà∑, {tag_count} Ê†áÁ≠æ, {task_count} ‰ªªÂä°")
            
            # Â§çÊùÇÊü•ËØ¢ÊµãËØï
            cur.execute("""
                SELECT t.title, array_agg(tag.name) as tags
                FROM tasks t
                LEFT JOIN task_tags tt ON t.id = tt.task_id
                LEFT JOIN tags tag ON tt.tag_id = tag.id
                GROUP BY t.id, t.title
                LIMIT 3
            """)
            
            results = cur.fetchall()
            logger.info("üìã ‰ªªÂä°ÂèäÊ†áÁ≠æ:")
            for task in results:
                tags_str = ", ".join(task[1]) if task[1] and task[1][0] else "Êó†Ê†áÁ≠æ"
                logger.info(f"  - {task[0]}: {tags_str}")
            
            cur.close()
            conn.close()
            
            logger.info("‚úÖ Êï∞ÊçÆÂ∫ìÊü•ËØ¢ÊµãËØïÂÆåÊàê!")
            return True
            
        except Exception as e:
            logger.error(f"‚ùå Êï∞ÊçÆÂ∫ìÊü•ËØ¢ÊµãËØïÂ§±Ë¥•: {e}")
            return False

    def test_api_server(self):
        """ÊµãËØïAPIÊúçÂä°Âô®"""
        try:
            logger.info("üöÄ ÊµãËØïAPIÊúçÂä°Âô®...")
            
            # ÂêØÂä®ÊúçÂä°Âô®
            process = subprocess.Popen([
                sys.executable, "-m", "uvicorn", 
                "app.main:app", 
                "--host", "0.0.0.0", 
                "--port", "8000",
                "--log-level", "error"
            ], cwd=Path(__file__).parent.parent, 
               stdout=subprocess.DEVNULL, 
               stderr=subprocess.DEVNULL)
            
            # Á≠âÂæÖÊúçÂä°Âô®ÂêØÂä®
            time.sleep(5)
            
            base_url = "http://localhost:8000"
            
            try:
                # ÊµãËØïÂÅ•Â∫∑Ê£ÄÊü•
                response = requests.get(f"{base_url}/health", timeout=10)
                if response.status_code == 200:
                    logger.info("‚úÖ ÂÅ•Â∫∑Ê£ÄÊü•Á´ØÁÇπÊ≠£Â∏∏")
                else:
                    logger.warning(f"‚ö†Ô∏è ÂÅ•Â∫∑Ê£ÄÊü•ËøîÂõûÁä∂ÊÄÅÁ†Å: {response.status_code}")
                
                # ÊµãËØïAPIÊñáÊ°£
                response = requests.get(f"{base_url}/docs", timeout=10)
                if response.status_code == 200:
                    logger.info("‚úÖ APIÊñáÊ°£Á´ØÁÇπÊ≠£Â∏∏")
                
                # ÊµãËØïOpenAPIËßÑËåÉ
                response = requests.get(f"{base_url}/openapi.json", timeout=10)
                if response.status_code == 200:
                    logger.info("‚úÖ OpenAPIËßÑËåÉÁ´ØÁÇπÊ≠£Â∏∏")
                
                logger.info("‚úÖ APIÊúçÂä°Âô®ÊµãËØïÂÆåÊàê!")
                return True
                
            except Exception as e:
                logger.warning(f"‚ö†Ô∏è APIÁ´ØÁÇπÊµãËØïÈÉ®ÂàÜÂ§±Ë¥•: {e}")
                return True  # ÊúçÂä°Âô®ËÉΩÂêØÂä®Â∞±ÁÆóÊàêÂäü
                
            finally:
                # ÂÅúÊ≠¢ÊúçÂä°Âô®
                process.terminate()
                process.wait()
                
        except Exception as e:
            logger.error(f"‚ùå APIÊúçÂä°Âô®ÊµãËØïÂ§±Ë¥•: {e}")
            return False

    def run_all_tests(self):
        """ËøêË°åÊâÄÊúâÊµãËØï"""
        logger.info("üéØ BountyGo Backend ÂÖ®Èù¢ÊµãËØï")
        logger.info("=" * 60)
        
        tests = [
            ("Êï∞ÊçÆÂ∫ìËøûÊé•ÊµãËØï", self.test_database_connection),
            ("Êï∞ÊçÆÂ∫ìÂàùÂßãÂåñ", self.initialize_database),
            ("Á§∫‰æãÊï∞ÊçÆÊèíÂÖ•", self.insert_sample_data),
            ("Ê®°ÂûãÂØºÂÖ•ÊµãËØï", self.test_models_import),
            ("Êï∞ÊçÆÂ∫ìÊü•ËØ¢ÊµãËØï", self.test_database_queries),
            ("APIÊúçÂä°Âô®ÊµãËØï", self.test_api_server),
        ]
        
        for test_name, test_func in tests:
            logger.info(f"\nüß™ {test_name}...")
            if test_func():
                self.success_count += 1
                logger.info(f"‚úÖ {test_name} ÈÄöËøá")
            else:
                logger.error(f"‚ùå {test_name} Â§±Ë¥•")
        
        # ÊÄªÁªì
        logger.info("\n" + "=" * 60)
        logger.info(f"üìä ÊµãËØïÁªìÊûú: {self.success_count}/{self.total_tests} ÈÄöËøá")
        
        if self.success_count == self.total_tests:
            logger.info("üéâ ÊâÄÊúâÊµãËØïÈÄöËøá! BountyGoÂêéÁ´ØÁ≥ªÁªüËøêË°åÊ≠£Â∏∏!")
            logger.info("\nüí° ÂêØÂä®Â∫îÁî®Á®ãÂ∫è:")
            logger.info("   uvicorn app.main:app --reload --host 0.0.0.0 --port 8000")
            logger.info("\nüåê ËÆøÈóÆAPIÊñáÊ°£:")
            logger.info("   http://localhost:8000/docs")
            return True
        else:
            logger.error("‚ùå ÈÉ®ÂàÜÊµãËØïÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÈîôËØØ‰ø°ÊÅØ")
            return False


def main():
    """‰∏ªÂáΩÊï∞"""
    tester = BountyGoTester()
    success = tester.run_all_tests()
    return 0 if success else 1


if __name__ == "__main__":
    exit_code = main()
    sys.exit(exit_code)